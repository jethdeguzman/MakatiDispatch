<!DOCTYPE html>
<html>
<head>
	<title>Makati Dispatch</title>
	<meta charset="utf-8" />
  	<meta name="format-detection" content="telephone=no" />
  	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	<!-- <link rel="stylesheet" href="assets/css/bootstrap.min.css" type="text/css"> -->
	<link rel="stylesheet" href="assets/css/font.css" type="text/css">
	<link rel="stylesheet" href="assets/css/holo-dark/base.css">
	<link rel="stylesheet" href="assets/css/holo-dark/action-bars.css"> 
	<link rel="stylesheet" href="assets/css/holo-dark/animations.css">
	<link rel="stylesheet" href="assets/css/holo-dark/buttons.css">
	<link rel="stylesheet" href="assets/css/holo-dark/content.css">
	<link rel="stylesheet" href="assets/css/holo-dark/dialogs.css">
	<link rel="stylesheet" href="assets/css/holo-dark/forms.css">
	<link rel="stylesheet" href="assets/css/holo-dark/icomoon.css">
	<link rel="stylesheet" href="assets/css/holo-dark/lists.css">
	<link rel="stylesheet" href="assets/css/holo-dark/sliders.css">
	<link rel="stylesheet" href="assets/css/holo-dark/spinners.css">
	<link rel="stylesheet" href="assets/css/holo-dark/stack.css">
	<link rel="stylesheet" href="assets/css/holo-dark/tabs.css">
	<link rel="stylesheet" href="assets/css/holo-dark/toasts.css"> 
	<link rel="stylesheet" href="assets/css/font-awesome.min.css">
	<link href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" />
	
	<!--Custom CSS-->
	<style type="text/css">
		a {
		  color: #C43B31;
		  text-decoration: none;
		   -webkit-tap-highlight-color: rgba(0,0,0,0);
  		   -webkit-tap-highlight-color: transparent; 
		}

		.content{
			color:black;
    		background-color:white;
			/*background: url("assets/images/binding_light/binding_light.png");*/
		}
		body .page{
			background: #FFF;
			color:#000;
		}

		header a i {
			color:white; 
			margin-top:5px;
		}
		
		.info-div, .hotlines-div{
			display: none;
			color:black;
		}
		.track-div{
			height:100%;
		}
		 #map-canvas{
		  	margin: 0;
	        padding: 0;
	        height: 91%;
	      
		}
		.ebutton{
			text-align: center;
			width:99%;
		}
		.info-div form label, .info-div form , .info-div form .flex-group input, .info-div form .flex-group ::-webkit-input-placeholder, .info-div form input::-webkit-input-placeholder {
			color: black;
		}
		.black{
			color: black;
		}
		button{
		   -webkit-tap-highlight-color: rgba(0,0,0,0);
  		   -webkit-tap-highlight-color: transparent; 
		}
	</style>

</head>

<body>
<!--page-->
 <div class="page">

 	<!--header-->
 	
 	<header class="action-bar fixed-top">
 	<a href="javascript: void(0);" class="app-icon action">
 	  <i style="" class="fa fa-plus-square fa-lg"></i>
 	</a>
 	  <h1 class="title"> &nbsp;Makati Dispatch</h1>
 	  <ul class="actions pull-right" style="margin-top:-2px;">

 	  
 	  <li><a href="" class="action" id="signout-btn" title="Signout" ><i class="fa fa-sign-out fa-lg"></i></a></li>
 	  	
 	  </ul>
 	</header>

 	<!--tab-->
    <nav class="tab-fixed">
	    <ul class="tab-inner">
	      <li  class="active"><a id="tab1" class="tab" data-tab="tab1" data-ignore="true">Track</a></li>
	      <li  class=""><a id="tab2" class="tab" data-tab="tab2" >Camera</a></li>
	     
	    </ul>
    </nav>
    
    <!--content -->
    <div class="content" >
    	
    	<!--Content of Home-->
    	
    	<div class="track-div" style="margin:0px;">
    		
    		<!--Map Container-->
    		 <div id="map-canvas"></div>
    		 
    		 <!--Address Container-->
    		 <div style="height:10%; border-top: 5px solid #393696; border-bottom: 5px solid #393696;text-align:center;   padding:5px; background-color:#7976D6;">
    		 <span ><i class="fa fa-location-arrow"></i><small id="location" style="padding:0px;">Please wait...</small></span>
    		
    		 </div>
    		
    	</div>

    	<!--Content of Info-->
    	<div class="camera-div" style="text-align:center;padding:10px; height:100%">
    		
    		 <img style="width:100%;height:70%;" id="largeImage" src="assets/images/placeholder.png" />
    		<button class="btn" id="albumbtn" style="display:inline;"><i class="icon-folder"></i>Album</button>
    		<button class="btn" id="camerabtn" style="display:inline;"><i class="icon-camera"></i> Camera</button>
    		<button class="btn btn-block" id="sendbtn"><i class="fa fa-cloud-upload"></i> Upload</button>
      	</div>


    </div>

    <div class="dialogs">
      <div id="dialog1" class="dialog">
      	<header class="dialog-title-region">
      		<h1 class="title">Hello</h1>
      	</header>
      	<div class="dialog-content">
      		<p>hi</p>
      	</div>
      	<ul class="dialog-actions">
      		<li><a href="javascript: void(0);" class="dialog-cancel-button">Cancel</a></li>
      		<li><a href="javascript: void(0);" class="dialog-ok-button">ok</a></li>

      	</ul>
      </div>

  </div>
<script src="assets/js/jquery-2.0.0.min.js" type="text/javascript"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true"></script>
<script type="text/javascript" charset="utf-8" src="assets/js/cordova-2.5.0.js"></script>
<!-- <script src="assets/js/action-bars.js" type="text/javascript"></script> -->
<script src="assets/js/gmaps.js" type="text/javascript"></script>
<script src="assets/js/default.js" type="text/javascript"></script>


 
</body>
<script>

	//device initialization
	document.addEventListener("deviceready", onDeviceReady, false);
	document.addEventListener("backbutton", onBack, false);
	function onDeviceReady() {
		
	    checkConnection();
	  	pictureSource=navigator.camera.PictureSourceType;
	  	destinationType=navigator.camera.DestinationType;


	  
	   
	}
	function onBack(){
		 navigator.app.exitApp();
	}

	function capturePhotoEdit() {
	      
	      navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, allowEdit: true,
	        destinationType: destinationType.FILE_URI });
	}

	function onPhotoURISuccess(imageURI) {

	      var largeImage = document.getElementById('largeImage');

	      largeImage.style.display = 'block';

	     
	      largeImage.src = imageURI;
	    }
	function getPhoto(source) {
	     // Retrieve image file location from specified source
	     navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, 
	       destinationType: destinationType.FILE_URI,
	       sourceType: source });
	   }
	   function uploadPhoto(imageURI) {
	           var options = new FileUploadOptions();
	           options.fileKey="file";
	           options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1);
	           options.mimeType="image/jpeg";
	   
	           var params = new Object();
	           params.type = getUnitInfo().type;
	           params.platenum = getUnitInfo().platenum;
	           params.id = getUnitInfo().id;
	           params.lat = getMapInfo().lat;
	           params.lng = getMapInfo().lng;
	           params.address = getMapInfo().address;
	   
	           options.params = params;
	           options.chunkedMode = false;
	   
	           var ft = new FileTransfer();
	           ft.upload(imageURI, "http://rescuemakati.cloudapp.net/unit/photo", win, fail, options);
	           alert("Successfully Sent");
	       }  
	   
	   function win(r) {
	           console.log("Code = " + r.responseCode);
	           console.log("Response = " + r.response);
	           console.log("Sent = " + r.bytesSent);
	           alert(r.response);
	       }

	     function onFail(message) {
	      alert('Failed because: ' + message);
	    }
	    function fail(error) {
	      alert("An error has occurred: Code = " = error.code);
	    }
	function checkConnection() {
	    var networkState = navigator.connection.type;

	    var states = {};
	    states[Connection.UNKNOWN]  = 'Unknown connection';
	    states[Connection.ETHERNET] = 'Ethernet connection';
	    states[Connection.WIFI]     = 'WiFi connection';
	    states[Connection.CELL_2G]  = 'Cell 2G connection';
	    states[Connection.CELL_3G]  = 'Cell 3G connection';
	    states[Connection.CELL_4G]  = 'Cell 4G connection';
	    states[Connection.NONE]     = 'No network connection';

	    if(networkState != "none"){
	    	// checkInternet() then initialize
	    	if(checkInternet()){
	    		initialize();
	    		load();
	 			
	    		return true;
	    	}else{
	    		load();
	    		$("#location").html("No Internet Connection");
	    		return false;
	    	}
	    	
	    }else{
	    	load();
	    	$("#location").html("No Internet Connection");
	    	return false;
	    }
		
	}

	
	
	jQuery(function($){
		
		$("#sendbtn").click(function(e){
			e.preventDefault();
			var imageuri =  $("#largeImage").attr('src');  
			var networkState = navigator.connection.type;

			var states = {};
			states[Connection.UNKNOWN]  = 'Unknown connection';
			states[Connection.ETHERNET] = 'Ethernet connection';
			states[Connection.WIFI]     = 'WiFi connection';
			states[Connection.CELL_2G]  = 'Cell 2G connection';
			states[Connection.CELL_3G]  = 'Cell 3G connection';
			states[Connection.CELL_4G]  = 'Cell 4G connection';
			states[Connection.NONE]     = 'No network connection';

			if(networkState != "none"){
				if(checkInternet()){
					uploadPhoto(imageuri); 
					
				}else{
					alert("Network Error");
				}

			}else{
				alert("Network Error");
			}
             
             // alert(checkConnection());
		});
		$("#camerabtn").click(function(e){
			e.preventDefault();
		    capturePhotoEdit();
		});
		$("#albumbtn").click(function(e){
			getPhoto(pictureSource.PHOTOLIBRARY);
		});
		$("#tab1").click(function(e){//show home-div
			e.preventDefault();
			x = '#'+ $(this).attr('id');
			showTrack(x);

		});
		$("#tab2").click(function(e){//show info-div
			e.preventDefault();
			$("img").attr('src',"assets/images/placeholder.png");
			x = '#'+ $(this).attr('id');
			showCamera(x);	
		});
		
		$("#signout-btn").click(function(e){
			e.preventDefault();
			localStorage.session = "false";
			location.href = "login.html";

		});
		
	});


	function load(){

	/*Transition of pages when tab is pressed.*/
		$(".camera-div").hide();		
		$(".track-div").show();	
		setInterval(function(){
			// alert("check");
			if(navigator.geolocation) {

				navigator.geolocation.getCurrentPosition(function(position) {
				  var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
				  var address;
				
				  map.panTo(pos);
				  // infowindow.setMap(map);
				  // infowindow.setPosition(pos);
				  // infowindow.setContent("<b><i class='fa fa-map-marker fa-lg'></i> You are here.</b>"); 
				  marker.setMap(map);
				  marker.setPosition(pos);
				  lat = position.coords.latitude;
				  lng = position.coords.longitude; 

				 // alert(lat + " " + lng);
				  // lat = 14.567676;
				  // lng = 121.04431;
				  var url = "http://maps.googleapis.com/maps/api/geocode/json?latlng="+lat+","+lng+"&sensor=true"; 
				  
				   
				   $.ajax({
				      type : "get",
				      url: url,
				      async : false,
				      success:function(data){

				        localStorage.location = "false";
				        address = data.results[0].formatted_address;
				        $("#location").html(data.results[0].formatted_address);
				         
				   	 	}
				  	});
				  
				  if(getMapInfo().address !== address) {
				  	//set new map info

				  	setMapInfo(lat, lng, address);
				  	// alert(getMapInfo().lat+ " "+ getMapInfo().lng + " "+getMapInfo().address);
				  	$.ajax({
				  		url : "http://rescuemakati.cloudapp.net/track/add",
				  		type : "POST",
				  		data : {
				  			id : getUnitInfo().id,
				  			type : getUnitInfo().type,
				  			platenum : getUnitInfo().platenum,
				  			lat : getMapInfo().lat,
				  			lng : getMapInfo().lng,
				  			address : getMapInfo().address
				  		},
				  		success : function(data){
				  			return;
				  		},
				  		error : function(err){
				  			console.log(err);
				  		}
				  	});

				  	
				  }
				 
				}, function() {
				  handleNoGeolocation(true);
				});
			}else{
				alert("none");
			}
		},10000);

	}

		

</script>
 <script src="assets/js/fingerblast.js"></script>
  <script src="assets/js/prettify.js"></script>
 <script src="assets/js/documentation.js"></script>

</body>
</html>